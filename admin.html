<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración de Usuarios</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; position: relative; }
table { width: 80%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
button { padding: 5px 10px; margin: 2px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; color: white; }
.checklist { margin: 10px 0; }
.checklist label { display: block; margin: 5px 0; }
.topButtons { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
#backButton { background: gray; }
#opButton { background: darkred; }
#logoutButton { background: black; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="topButtons">
    <button id="backButton" onclick="window.location.href='index.html'">Volver</button>
    <button id="opButton" onclick="editAdmin()">OP</button>
    <button id="logoutButton" onclick="logout()">Cerrar sesión</button>
</div>

<h2>Gestión de Usuarios</h2>
<table id="userTable">
<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Acciones</th></tr>
</table>

<h3>Añadir nuevo usuario</h3>
<input type="text" id="newUser" placeholder="Usuario">
<input type="text" id="newPass" placeholder="Contraseña">
<div id="newUserPages" class="checklist"></div>
<button onclick="addUser()" style="background-color:#28a745; color:white; font-weight:bold;">Añadir usuario</button>

<script>
// === CONFIGURACIÓN FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyARrsVZ2LboEe5MblE8GKXVnas-zHB4k5I",
  authDomain: "et-accounts.firebaseapp.com",
  databaseURL: "https://et-accounts-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "et-accounts",
  storageBucket: "et-accounts.firebasestorage.app",
  messagingSenderId: "1006439185867",
  appId: "1:1006439185867:web:ee9221150be923340e4a4e"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const usersRef = database.ref('users');

const availablePages = ["multi.html", "ss.html", "vote.html", "admin.html"];

window.onload = function() {
    const currentUser = localStorage.getItem("currentUser");
    if(!currentUser){
        alert("Debes iniciar sesión");
        window.location.href = "index.html";
    } else {
        usersRef.child(currentUser).once('value', snapshot => {
            if(!snapshot.exists()){
                alert("Usuario no encontrado");
                window.location.href = "index.html";
            } else {
                const data = snapshot.val();
                if(!data.pages.includes("admin.html")){
                    alert("No tienes permiso para acceder a esta página");
                    window.location.href = "index.html";
                } else {
                    // Usuario permitido, carga normal
                    renderUsers();
                    renderPageChecklist('newUserPages');
                }
            }
        });
    }
};

function renderPageChecklist(containerId, selectedPages = []) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    availablePages.forEach(page => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = page;
        if (selectedPages.includes(page)) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + page));
        container.appendChild(label);
    });
}

function renderUsers() {
    const table = document.getElementById("userTable");
    table.innerHTML = '<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Acciones</th></tr>';
    usersRef.once('value', snapshot => {
        snapshot.forEach(childSnap => {
            const user = childSnap.key;
            const data = childSnap.val();
            if(user === "admin") return;

            const row = table.insertRow();
            row.insertCell(0).textContent = user;

            // Contraseña oculta con botón mostrar
            const passCell = row.insertCell(1);
            passCell.style.display = "flex";
            passCell.style.alignItems = "center";
            passCell.style.gap = "5px";

            const passSpan = document.createElement("span");
            passSpan.textContent = "********"; // Oculta por defecto
            passCell.appendChild(passSpan);

            const showBtn = document.createElement("button");
            showBtn.textContent = "Mostrar";
            showBtn.style.backgroundColor = "#17A2B8"; // azul claro
            showBtn.onclick = () => {
                if(passSpan.textContent === "********") {
                    passSpan.textContent = atob(data.password);
                    showBtn.textContent = "Ocultar";
                } else {
                    passSpan.textContent = "********";
                    showBtn.textContent = "Mostrar";
                }
            };
            passCell.appendChild(showBtn);

            row.insertCell(2).textContent = data.pages.join(", ");

            const actions = row.insertCell(3);
            const editBtn = document.createElement("button");
            editBtn.textContent = "Editar";
            editBtn.style.backgroundColor = "#007BFF";
            editBtn.onclick = () => editUser(user, data);
            actions.appendChild(editBtn);

            const delBtn = document.createElement("button");
            delBtn.textContent = "Eliminar";
            delBtn.style.backgroundColor = "#DC3545";
            delBtn.onclick = () => deleteUser(user);
            actions.appendChild(delBtn);
        });
    });
}

function addUser() {
    const username = document.getElementById("newUser").value.trim();
    const password = document.getElementById("newPass").value.trim();
    const pages = Array.from(document.querySelectorAll('#newUserPages input:checked')).map(cb => cb.value);

    if(!username || !password) { alert("Usuario y contraseña obligatorios"); return; }

    usersRef.child(username).set({ password: btoa(password), pages });
    renderUsers();
    document.getElementById("newUser").value = "";
    document.getElementById("newPass").value = "";
    renderPageChecklist('newUserPages');
}

function editAdmin() {
    const inputPin = prompt("Introduce el PIN de seguridad para editar ADMIN:");
    usersRef.child("admin").once('value', snapshot => {
        if (!snapshot.exists()) { alert("No se encontró admin."); return; }
        const data = snapshot.val();
        const storedPin = data.pin ? atob(data.pin) : "Taru85";

        if(inputPin !== storedPin){ alert("PIN incorrecto. Acceso denegado."); return; }

        const modal = document.createElement('div');
        modal.style.position='fixed'; modal.style.top='0'; modal.style.left='0';
        modal.style.width='100%'; modal.style.height='100%';
        modal.style.background='rgba(0,0,0,0.5)';
        modal.style.display='flex'; modal.style.justifyContent='center'; modal.style.alignItems='center';
        modal.style.zIndex='1000';

        modal.innerHTML = `
            <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:100%;">
                <h3>Editar ADMIN</h3>
                <label>Contraseña:</label>
                <input type="password" id="adminPassword" value="${atob(data.password)}" style="width:100%; margin-bottom:10px; padding:5px;">
                <button id="toggleAdminPass" style="margin-bottom:10px; background:#17A2B8;">Mostrar</button>
                <label>Páginas:</label>
                <div id="adminPages" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
                <label>NUEVO PIN:</label>
                <input type="text" id="adminPin" value="${data.pin ? atob(data.pin) : ''}" style="width:100%; margin-bottom:10px; padding:5px;">
                <div style="text-align:right;">
                    <button id="cancelAdmin" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                    <button id="saveAdmin" style="background:green; color:white;">Guardar</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        renderPageChecklist('adminPages', data.pages);

        const toggleBtn = document.getElementById('toggleAdminPass');
        const passInput = document.getElementById('adminPassword');
        toggleBtn.onclick = () => {
            if(passInput.type === "password") { passInput.type="text"; toggleBtn.textContent="Ocultar"; }
            else { passInput.type="password"; toggleBtn.textContent="Mostrar"; }
        };

        document.getElementById('cancelAdmin').onclick = () => modal.remove();
        document.getElementById('saveAdmin').onclick = () => {
            const newPassword = document.getElementById('adminPassword').value.trim();
            const newPages = Array.from(document.querySelectorAll('#adminPages input:checked')).map(cb=>cb.value);
            const newPin = document.getElementById('adminPin').value.trim();
            if(!newPassword){ alert("La contraseña no puede estar vacía."); return; }
            usersRef.child("admin").update({ password: btoa(newPassword), pages: newPages, pin: btoa(newPin) })
              .then(()=>{ alert("Admin actualizado."); modal.remove(); })
              .catch(err=>alert("Error: "+err.message));
        };
    });
}

// Funciones editUser, deleteUser y logout siguen igual
function editUser(user, data) {
    const modal=document.createElement('div');
    modal.style.position='fixed'; modal.style.top='0'; modal.style.left='0';
    modal.style.width='100%'; modal.style.height='100%';
    modal.style.background='rgba(0,0,0,0.5)';
    modal.style.display='flex'; modal.style.justifyContent='center'; modal.style.alignItems='center';
    modal.style.zIndex='1000';

    modal.innerHTML=`
        <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:100%;">
            <h3>Editar usuario: ${user}</h3>
            <label>Contraseña:</label>
            <input type="password" id="editPassword" value="${atob(data.password)}" style="width:100%; margin-bottom:10px; padding:5px;">
            <button id="toggleUserPass" style="margin-bottom:10px; background:#17A2B8;">Mostrar</button>
            <label>Páginas:</label>
            <div id="editUserPages" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
            <div style="text-align:right;">
                <button id="cancelEdit" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                <button id="saveChanges" style="background:green; color:white;">Guardar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    renderPageChecklist('editUserPages', data.pages);

    const toggleBtn = document.getElementById('toggleUserPass');
    const passInput = document.getElementById('editPassword');
    toggleBtn.onclick = () => {
        if(passInput.type === "password") { passInput.type="text"; toggleBtn.textContent="Ocultar"; }
        else { passInput.type="password"; toggleBtn.textContent="Mostrar"; }
    };

    document.getElementById('cancelEdit').onclick = ()=>modal.remove();
    document.getElementById('saveChanges').onclick = ()=>{
        const newPassword=document.getElementById('editPassword').value.trim();
        const newPages=Array.from(document.querySelectorAll('#editUserPages input:checked')).map(cb=>cb.value);
        if(!newPassword){ alert("Contraseña vacía."); return; }
        usersRef.child(user).update({ password:btoa(newPassword), pages:newPages })
        .then(()=>{ alert("Usuario actualizado."); modal.remove(); renderUsers(); })
        .catch(err=>alert("Error: "+err.message));
    };
}

function deleteUser(user){
    if(confirm("¿Eliminar usuario "+user+"?")){
        usersRef.child(user).remove();
        renderUsers();
    }
}

function logout(){
    localStorage.removeItem("currentUser");
    window.location.href="index.html";
}
</script>
</body>
</html>
