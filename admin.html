<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración de Usuarios</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; position: relative; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
button { padding: 5px 10px; margin: 2px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; color: white; }
.checklist { margin: 10px 0; }
.checklist label { display: block; margin: 5px 0; }
.topButtons { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
#backButton { background: gray; }
#opButton { background: darkred; }
#logoutButton { background: black; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="topButtons">
    <button id="backButton" onclick="window.location.href='index.html'">Volver</button>
    <button id="opButton" onclick="editAdmin()">OP</button>
    <button id="logoutButton" onclick="logout()">Cerrar sesión</button>
</div>

<h2>Gestión de Usuarios</h2>
<table id="userTable">
<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Administrador</th><th>Acciones</th></tr>
</table>

<h3>Añadir nuevo usuario</h3>
<input type="text" id="newUser" placeholder="Usuario">
<input type="text" id="newPass" placeholder="Contraseña">
<label><input type="checkbox" id="newIsAdmin"> Administrador</label>
<div id="newUserPages" class="checklist"></div>
<button onclick="addUser()" style="background-color:#28a745; color:white; font-weight:bold;">Añadir usuario</button>

<script>
// === CONFIGURACIÓN FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyARrsVZ2LboEe5MblE8GKXVnas-zHB4k5I",
  authDomain: "et-accounts.firebaseapp.com",
  databaseURL: "https://et-accounts-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "et-accounts",
  storageBucket: "et-accounts.firebasestorage.app",
  messagingSenderId: "1006439185867",
  appId: "1:1006439185867:web:ee9221150be923340e4a4e"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const usersRef = database.ref('users');

const availablePages = ["multi.html", "ss.html", "vote.html", "admin.html"];
let currentUser = localStorage.getItem("currentUser");
let currentUserData = {};

window.onload = function() {
    if(!currentUser){
        alert("Debes iniciar sesión");
        window.location.href = "index.html";
        return;
    }
    usersRef.child(currentUser).once('value', snapshot => {
        if(!snapshot.exists()){
            alert("Usuario no encontrado");
            window.location.href = "index.html";
        } else {
            currentUserData = snapshot.val();
            // Solo permite acceder a admin.html si tiene acceso
            if(!currentUserData.pages.includes("admin.html")){
                alert("No tienes permiso para acceder a esta página");
                window.location.href = "index.html";
            } else if(!currentUserData.isAdmin && currentUser !== "admin"){
                alert("Solo administradores pueden acceder");
                window.location.href = "index.html";
            } else {
                renderUsers();
                renderPageChecklist('newUserPages');
            }
        }
    });
};

function renderPageChecklist(containerId, selectedPages = []) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    availablePages.forEach(page => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = page;
        if (selectedPages.includes(page)) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + page));
        container.appendChild(label);
    });
}

function renderUsers() {
    const table = document.getElementById("userTable");
    table.innerHTML = '<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Administrador</th><th>Acciones</th></tr>';
    usersRef.once('value', snapshot => {
        snapshot.forEach(childSnap => {
            const user = childSnap.key;
            const data = childSnap.val();

            const row = table.insertRow();
            row.insertCell(0).textContent = user;

            // Contraseña oculta con botón mostrar
            const passCell = row.insertCell(1);
            passCell.style.display = "flex";
            passCell.style.alignItems = "center";
            passCell.style.gap = "5px";
            const passSpan = document.createElement("span");
            passSpan.textContent = "********";
            passCell.appendChild(passSpan);
            const showBtn = document.createElement("button");
            showBtn.textContent = "Mostrar";
            showBtn.style.backgroundColor = "#17A2B8";
            showBtn.onclick = () => {
                if(passSpan.textContent === "********") { passSpan.textContent = atob(data.password); showBtn.textContent = "Ocultar"; }
                else { passSpan.textContent = "********"; showBtn.textContent = "Mostrar"; }
            };
            passCell.appendChild(showBtn);

            row.insertCell(2).textContent = data.pages.join(", ");

            // Administrador
            const adminCell = row.insertCell(3);
            if(currentUser === "admin"){ // solo admin puede cambiar rango
                const adminCheckbox = document.createElement("input");
                adminCheckbox.type = "checkbox";
                adminCheckbox.checked = data.isAdmin || false;
                adminCheckbox.onclick = () => {
                    if(user === "admin"){ alert("No puedes cambiar el rango de admin principal"); adminCheckbox.checked=true; return;}
                    usersRef.child(user).update({ isAdmin: adminCheckbox.checked });
                };
                adminCell.appendChild(adminCheckbox);
            } else {
                adminCell.textContent = data.isAdmin ? "Sí" : "No";
            }

            // Acciones
            const actions = row.insertCell(4);
            const editBtn = document.createElement("button");
            editBtn.textContent = "Editar";
            editBtn.style.backgroundColor = "#007BFF";
            editBtn.onclick = () => editUser(user, data);
            actions.appendChild(editBtn);
            const delBtn = document.createElement("button");
            delBtn.textContent = "Eliminar";
            delBtn.style.backgroundColor = "#DC3545";
            delBtn.onclick = () => {
                if(user==="admin"){ alert("No puedes eliminar el admin principal"); return; }
                deleteUser(user);
            };
            actions.appendChild(delBtn);
        });
    });
}

function addUser() {
    const username = document.getElementById("newUser").value.trim();
    const password = document.getElementById("newPass").value.trim();
    const pages = Array.from(document.querySelectorAll('#newUserPages input:checked')).map(cb => cb.value);
    let isAdmin = false;
    if(currentUser === "admin"){ // solo admin puede asignar rango
        isAdmin = document.getElementById("newIsAdmin").checked;
    }
    if(!username || !password){ alert("Usuario y contraseña obligatorios"); return; }
    usersRef.child(username).set({ password: btoa(password), pages, isAdmin });
    renderUsers();
    document.getElementById("newUser").value="";
    document.getElementById("newPass").value="";
    renderPageChecklist('newUserPages');
    if(currentUser==="admin"){ document.getElementById("newIsAdmin").checked=false; }
}

// editAdmin, editUser y logout siguen igual que antes, manteniendo la visualización de contraseñas
// Solo cambia que ahora cualquier admin puede editar usuarios, pero no cambiar rango si no es admin principal
// Puedes integrar tu código de modal de edición con botones Mostrar/Ocultar aquí

function logout(){
    localStorage.removeItem("currentUser");
    window.location.href="index.html";
}
</script>
</body>
</html>
