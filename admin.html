<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EToolz - Administracion</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; position: relative; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
button { padding: 5px 10px; margin: 2px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; color: white; }
.checklist { margin: 10px 0; }
.checklist label { display: block; margin: 5px 0; }
.topButtons { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
#backButton { background: gray; }
#opButton { background: darkred; }
#logoutButton { background: black; }
#chatBox { border:1px solid #ccc; height:200px; overflow-y:scroll; padding:10px; margin-bottom:10px; background:#f9f9f9; }
#chatInput { width:80%; padding:5px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="topButtons">
    <button id="backButton" onclick="window.location.href='index.html'">Volver</button>
    <button id="opButton" onclick="editAdmin()">OP</button>
    <button id="logoutButton" onclick="logout()">Cerrar sesión</button>
</div>

<h2>Gestión de Usuarios</h2>
<table id="userTable">
<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Administrador</th><th>Acciones</th></tr>
</table>

<h3>Añadir nuevo usuario</h3>
<input type="text" id="newUser" placeholder="Usuario">
<input type="text" id="newPass" placeholder="Contraseña">
<label><input type="checkbox" id="newIsAdmin"> Administrador</label>
<div id="newUserPages" class="checklist"></div>
<button onclick="addUser()" style="background-color:#28a745; color:white; font-weight:bold;">Añadir usuario</button>

<h3>Chat de Administradores</h3>
<div id="chatBox"></div>
<input type="text" id="chatInput" placeholder="Escribe tu mensaje...">
<button onclick="sendMessage()" style="background:#007BFF; color:white; font-weight:bold;">Enviar</button>

<script>
// === CONFIGURACIÓN FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyARrsVZ2LboEe5MblE8GKXVnas-zHB4k5I",
  authDomain: "et-accounts.firebaseapp.com",
  databaseURL: "https://et-accounts-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "et-accounts",
  storageBucket: "et-accounts.firebasestorage.app",
  messagingSenderId: "1006439185867",
  appId: "1:1006439185867:web:ee9221150be923340e4a4e"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const usersRef = database.ref('users');
const chatRef = database.ref('adminChat');

const availablePages = ["sanciones.html", "notas.html", "multi.html", "ss.html", "vote.html", "admin.html"];
let currentUser = localStorage.getItem("currentUser");
let currentUserData = {};

window.onload = function() {
    if(!currentUser){ alert("Debes iniciar sesión"); window.location.href = "index.html"; return; }
    usersRef.child(currentUser).once('value', snapshot => {
        if(!snapshot.exists()){ alert("Usuario no encontrado"); window.location.href = "index.html"; return; }
        currentUserData = snapshot.val();
        if(currentUser !== "admin" && (!currentUserData.pages.includes("admin.html") || !currentUserData.isAdmin)){
            alert("Solo administradores pueden acceder"); window.location.href = "index.html"; return;
        }
        renderUsers();
        renderPageChecklist('newUserPages');
        renderChat();
    });

    document.getElementById('chatInput').addEventListener('keypress', function(e){
        if(e.key === 'Enter'){
            e.preventDefault();
            sendMessage();
        }
    });
};

function renderPageChecklist(containerId, selectedPages = []) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    availablePages.forEach(page => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = page;
        if (selectedPages.includes(page)) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + page));
        container.appendChild(label);
    });
}

function renderUsers() {
    const table = document.getElementById("userTable");
    table.innerHTML = '<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Administrador</th><th>Acciones</th></tr>';
    usersRef.once('value', snapshot => {
        snapshot.forEach(childSnap => {
            const user = childSnap.key;
            const data = childSnap.val();
            if(user === "admin") return;
            const row = table.insertRow();
            row.insertCell(0).textContent = user;

            const passCell = row.insertCell(1);
            passCell.style.display="flex"; passCell.style.alignItems="center"; passCell.style.gap="5px";
            const passSpan = document.createElement("span"); passSpan.textContent="********"; passCell.appendChild(passSpan);
            const showBtn = document.createElement("button"); showBtn.textContent="Mostrar"; showBtn.style.backgroundColor="#17A2B8";
            showBtn.onclick = ()=>{ if(passSpan.textContent==="********"){ passSpan.textContent=atob(data.password); showBtn.textContent="Ocultar"; } else{ passSpan.textContent="********"; showBtn.textContent="Mostrar"; } };
            passCell.appendChild(showBtn);

            row.insertCell(2).textContent = data.pages.join(", ");

            const adminCell = row.insertCell(3);
            if(currentUser==="admin"){
                const adminCheckbox = document.createElement("input");
                adminCheckbox.type="checkbox"; adminCheckbox.checked=data.isAdmin||false;
                adminCheckbox.onclick = ()=>usersRef.child(user).update({isAdmin:adminCheckbox.checked});
                adminCell.appendChild(adminCheckbox);
            } else { adminCell.textContent=data.isAdmin?"Sí":"No"; }

            const actions = row.insertCell(4);
            const editBtn = document.createElement("button"); editBtn.textContent="Editar"; editBtn.style.backgroundColor="#007BFF"; editBtn.onclick = ()=>editUser(user,data); actions.appendChild(editBtn);
            const delBtn = document.createElement("button"); delBtn.textContent="Eliminar"; delBtn.style.backgroundColor="#DC3545"; delBtn.onclick = ()=>deleteUser(user); actions.appendChild(delBtn);
        });
    });
}

function editAdmin(){
    const pin = prompt("Introduce tu PIN de seguridad:");
    if(pin !== "Taru85"){ alert("PIN incorrecto"); return; }

    const modal=document.createElement('div');
    modal.style='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;';
    
    modal.innerHTML=`
        <div style="background:white;padding:20px;border-radius:10px;max-width:400px;width:100%;">
            <h3>Editar Admin</h3>
            <label>Nueva contraseña:</label>
            <input type="password" id="adminNewPass" style="width:100%; margin-bottom:10px; padding:5px;">
            
            <label>Páginas:</label>
            <div id="adminPagesChecklist" class="checklist" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
            
            <div style="text-align:right;">
                <button id="cancelAdmin" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                <button id="saveAdmin" style="background:green; color:white;">Guardar</button>
            </div>
        </div>`;

    document.body.appendChild(modal);

    renderPageChecklist('adminPagesChecklist', currentUserData.pages || availablePages);

    document.getElementById('cancelAdmin').onclick = ()=>modal.remove();

    document.getElementById('saveAdmin').onclick = ()=>{
        const newPass = document.getElementById('adminNewPass').value.trim();
        const newPages = Array.from(document.querySelectorAll('#adminPagesChecklist input:checked')).map(cb=>cb.value);

        const updates = { pages: newPages };
        if(newPass) updates.password = btoa(newPass);

        usersRef.child("admin").update(updates).then(()=>{
            alert("Admin actualizado correctamente");
            modal.remove();
        });
    };
}

function editUser(user,data){
    const modal=document.createElement('div');
    modal.style='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;';
    modal.innerHTML=`
        <div style="background:white;padding:20px;border-radius:10px;max-width:400px;width:100%;">
            <h3>Editar usuario: ${user}</h3>
            <label>Contraseña:</label>
            <input type="password" id="editPassword" value="${atob(data.password)}" style="width:100%; margin-bottom:10px; padding:5px;">
            <button id="togglePass" style="margin-bottom:10px; background:#17A2B8;">Mostrar</button>
            <label>Páginas:</label>
            <div id="editUserPages" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
            <div style="text-align:right;">
                <button id="cancelEdit" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                <button id="saveChanges" style="background:green; color:white;">Guardar</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    renderPageChecklist('editUserPages', data.pages);

    document.getElementById('togglePass').onclick = ()=>{
        const passInput = document.getElementById('editPassword');
        if(passInput.type==="password"){ passInput.type="text"; document.getElementById('togglePass').textContent="Ocultar"; }
        else{ passInput.type="password"; document.getElementById('togglePass').textContent="Mostrar"; }
    };

    document.getElementById('cancelEdit').onclick = ()=>modal.remove();
    document.getElementById('saveChanges').onclick = ()=>{
        const newPass = document.getElementById('editPassword').value.trim();
        const newPages = Array.from(document.querySelectorAll('#editUserPages input:checked')).map(cb=>cb.value);
        if(!newPass){ alert("Contraseña vacía"); return; }
        usersRef.child(user).update({password:btoa(newPass), pages:newPages}).then(()=>{ alert("Usuario actualizado"); modal.remove(); renderUsers(); });
    };
}

function deleteUser(user){
    if(confirm(`¿Eliminar usuario ${user}?`)){ usersRef.child(user).remove().then(()=>renderUsers()); }
}

function addUser(){
    const username=document.getElementById("newUser").value.trim();
    const password=document.getElementById("newPass").value.trim();
    const pages=Array.from(document.querySelectorAll('#newUserPages input:checked')).map(cb=>cb.value);
    let isAdmin=false;
    if(currentUser==="admin"){ isAdmin=document.getElementById("newIsAdmin").checked; }
    if(!username || !password){ alert("Usuario y contraseña obligatorios"); return; }
    usersRef.child(username).set({password:btoa(password), pages, isAdmin});
    renderUsers();
    document.getElementById("newUser").value="";
    document.getElementById("newPass").value="";
    renderPageChecklist('newUserPages');
    if(currentUser==="admin"){ document.getElementById("newIsAdmin").checked=false; }
}

function logout(){ localStorage.removeItem("currentUser"); window.location.href="index.html"; }

function sendMessage(){
    const msg = document.getElementById('chatInput').value.trim();
    if(!msg) return;
    chatRef.push({ user: currentUser, message: msg, time: Date.now() });
    document.getElementById('chatInput').value="";
}

function renderChat(){
    chatRef.on('value', snapshot=>{
        const chatBox=document.getElementById('chatBox');
        chatBox.innerHTML='';
        const messages = snapshot.val();
        if(messages){
            Object.values(messages).forEach(msg=>{
                const div=document.createElement('div');
                const date = new Date(msg.time);
                const hours = date.getHours().toString().padStart(2,'0');
                const minutes = date.getMinutes().toString().padStart(2,'0');
                div.innerHTML = `<strong>${msg.user}</strong> [${hours}:${minutes}]: ${msg.message}`;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });
}
</script>
</body>
</html>

