<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración de Usuarios</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; position: relative; }
table { width: 80%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
button { padding: 5px 10px; margin: 2px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; color: white; }
.checklist { margin: 10px 0; }
.checklist label { display: block; margin: 5px 0; }
.topButtons { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
#backButton { background: gray; }
#opButton { background: darkred; }
#logoutButton { background: black; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="topButtons">
    <button id="backButton" onclick="window.location.href='index.html'">Volver</button>
    <button id="opButton" onclick="editAdmin()">OP</button>
    <button id="logoutButton" onclick="logout()">Cerrar sesión</button>
</div>

<h3 style="text-align:center;">Usuarios Conectados</h3>
<table id="connectedTable" style="margin:auto;">
    <tr><th>Usuario</th></tr>
</table>

<h2>Gestión de Usuarios</h2>
<table id="userTable">
<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Acciones</th></tr>
</table>

<h3>Añadir nuevo usuario</h3>
<input type="text" id="newUser" placeholder="Usuario">
<input type="text" id="newPass" placeholder="Contraseña">
<div id="newUserPages" class="checklist"></div>
<button onclick="addUser()">Añadir usuario</button>

<script>
// === CONFIGURACIÓN FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyARrsVZ2LboEe5MblE8GKXVnas-zHB4k5I",
  authDomain: "et-accounts.firebaseapp.com",
  databaseURL: "https://et-accounts-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "et-accounts",
  storageBucket: "et-accounts.firebasestorage.app",
  messagingSenderId: "1006439185867",
  appId: "1:1006439185867:web:ee9221150be923340e4a4e"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const usersRef = database.ref('users');
const connectedRef = database.ref('connectedUsers');

const availablePages = ["multi.html", "ss.html", "vote.html", "admin.html"];

window.onload = function() {
    const currentUser = localStorage.getItem("currentUser");
    if(currentUser !== "admin") {
        alert("Acceso denegado");
        window.location.href = "index.html";
    } else {
        renderUsers();
        renderPageChecklist('newUserPages');
        renderConnectedUsers();
        connectedRef.on('value', renderConnectedUsers);
    }
};

function renderPageChecklist(containerId, selectedPages = []) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    availablePages.forEach(page => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = page;
        if (selectedPages.includes(page)) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + page));
        container.appendChild(label);
    });
}

function renderConnectedUsers() {
    const table = document.getElementById("connectedTable");
    table.innerHTML = '<tr><th>Usuario</th></tr>';
    connectedRef.once('value', snapshot => {
        snapshot.forEach(childSnap => {
            const user = childSnap.key;
            const row = table.insertRow();
            row.insertCell(0).textContent = user;
        });
    });
}

function renderUsers() {
    const table = document.getElementById("userTable");
    table.innerHTML = '<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Acciones</th></tr>';
    usersRef.once('value', snapshot => {
        snapshot.forEach(childSnap => {
            const user = childSnap.key;
            const data = childSnap.val();
            if(user === "admin") return;

            const row = table.insertRow();
            row.insertCell(0).textContent = user;
            row.insertCell(1).textContent = atob(data.password);
            row.insertCell(2).textContent = data.pages.join(", ");

            const actions = row.insertCell(3);
            const editBtn = document.createElement("button");
            editBtn.textContent = "Editar";
            editBtn.style.backgroundColor = "#007BFF";
            editBtn.onclick = () => editUser(user, data);
            actions.appendChild(editBtn);

            const delBtn = document.createElement("button");
            delBtn.textContent = "Eliminar";
            delBtn.style.backgroundColor = "#DC3545";
            delBtn.onclick = () => deleteUser(user);
            actions.appendChild(delBtn);
        });
    });
}

function addUser() {
    const username = document.getElementById("newUser").value.trim();
    const password = document.getElementById("newPass").value.trim();
    const pages = Array.from(document.querySelectorAll('#newUserPages input:checked')).map(cb => cb.value);

    if(!username || !password) { alert("Usuario y contraseña obligatorios"); return; }

    usersRef.child(username).set({ password: btoa(password), pages });
    renderUsers();
    document.getElementById("newUser").value = "";
    document.getElementById("newPass").value = "";
    renderPageChecklist('newUserPages');
}

function editAdmin() {
    const inputPin = prompt("Introduce el PIN de seguridad para editar ADMIN:");

    usersRef.child("admin").once('value', snapshot => {
        if (!snapshot.exists()) { alert("No se encontró admin."); return; }
        const data = snapshot.val();
        const storedPin = data.pin ? atob(data.pin) : "Taru85";

        if(inputPin !== storedPin){ alert("PIN incorrecto. Acceso denegado."); return; }

        const modal = document.createElement('div');
        modal.style.position='fixed'; modal.style.top='0'; modal.style.left='0';
        modal.style.width='100%'; modal.style.height='100%';
        modal.style.background='rgba(0,0,0,0.5)';
        modal.style.display='flex'; modal.style.justifyContent='center'; modal.style.alignItems='center';
        modal.style.zIndex='1000';

        modal.innerHTML = `
            <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:100%;">
                <h3>Editar ADMIN</h3>
                <label>Contraseña:</label>
                <input type="text" id="adminPassword" value="${atob(data.password)}" style="width:100%; margin-bottom:10px; padding:5px;">
                <label>Páginas:</label>
                <div id="adminPages" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
                <label>NUEVO PIN:</label>
                <input type="text" id="adminPin" value="${data.pin ? atob(data.pin) : ''}" style="width:100%; margin-bottom:10px; padding:5px;">
                <div style="text-align:right;">
                    <button id="cancelAdmin" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                    <button id="saveAdmin" style="background:green; color:white;">Guardar</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        renderPageChecklist('adminPages', data.pages);

        document.getElementById('cancelAdmin').onclick = () => modal.remove();
        document.getElementById('saveAdmin').onclick = () => {
            const newPassword = document.getElementById('adminPassword').value.trim();
            const newPages = Array.from(document.querySelectorAll('#adminPages input:checked')).map(cb=>cb.value);
            const newPin = document.getElementById('adminPin').value.trim();

            if(!newPassword){ alert("La contraseña no puede estar vacía."); return; }

            usersRef.child("admin").update({
                password: btoa(newPassword),
                pages: newPages,
                pin: btoa(newPin)
            }).then(()=>{ alert("Admin actualizado."); modal.remove(); })
              .catch(err=>alert("Error: "+err.message));
        };
    });
}

function editUser(user, data) {
    const modal=document.createElement('div');
    modal.style.position='fixed'; modal.style.top='0'; modal.style.left='0';
    modal.style.width='100%'; modal.style.height='100%';
    modal.style.background='rgba(0,0,0,0.5)';
    modal.style.display='flex'; modal.style.justifyContent='center'; modal.style.alignItems='center';
    modal.style.zIndex='1000';

    modal.innerHTML=`
        <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:100%;">
            <h3>Editar usuario: ${user}</h3>
            <label>Contraseña:</label>
            <input type="text" id="editPassword" value="${atob(data.password)}" style="width:100%; margin-bottom:10px; padding:5px;">
            <label>Páginas:</label>
            <div id="editUserPages" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
            <div style="text-align:right;">
                <button id="cancelEdit" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                <button id="saveChanges" style="background:green; color:white;">Guardar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    renderPageChecklist('editUserPages', data.pages);

    document.getElementById('cancelEdit').onclick = ()=>modal.remove();
    document.getElementById('saveChanges').onclick = ()=>{
        const newPassword=document.getElementById('editPassword').value.trim();
        const newPages=Array.from(document.querySelectorAll('#editUserPages input:checked')).map(cb=>cb.value);
        if(!newPassword){ alert("Contraseña vacía."); return; }
        usersRef.child(user).update({ password:btoa(newPassword), pages:newPages })
        .then(()=>{ alert("Usuario actualizado."); modal.remove(); renderUsers(); })
        .catch(err=>alert("Error: "+err.message));
    };
}

function deleteUser(user){
    if(confirm("¿Eliminar usuario "+user+"?")){
        usersRef.child(user).remove();
        renderUsers();
    }
}

function logout(){
    const user = localStorage.getItem("currentUser");
    connectedRef.child(user).remove();
    localStorage.removeItem("currentUser");
    window.location.href="index.html";
}
</script>
</body>
</html>
