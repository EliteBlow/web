<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración de Usuarios</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; position: relative; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
button { padding: 5px 10px; margin: 2px; cursor: pointer; }
.checklist { margin: 10px 0; }
.checklist label { display: block; margin: 5px 0; }
#opButton {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: darkred;
  color: white;
  font-weight: bold;
  padding: 8px 12px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h2>Gestión de Usuarios</h2>
<button id="opButton" onclick="editAdmin()">OP</button>

<table id="userTable">
<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Acciones</th></tr>
</table>

<h3>Añadir nuevo usuario</h3>
<input type="text" id="newUser" placeholder="Usuario">
<input type="text" id="newPass" placeholder="Contraseña">

<div id="newUserPages" class="checklist"></div>

<button onclick="addUser()">Añadir usuario</button>

<br><br>
<button onclick="logout()">Cerrar sesión</button>

<script>
// === CONFIGURACIÓN FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyARrsVZ2LboEe5MblE8GKXVnas-zHB4k5I",
  authDomain: "et-accounts.firebaseapp.com",
  databaseURL: "https://et-accounts-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "et-accounts",
  storageBucket: "et-accounts.firebasestorage.app",
  messagingSenderId: "1006439185867",
  appId: "1:1006439185867:web:ee9221150be923340e4a4e"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const usersRef = database.ref('users');

// === LISTA DE PÁGINAS DISPONIBLES ===
const availablePages = ["multi.html", "ss.html", "vote.html", "admin.html"];

// === INICIO ===
window.onload = function() {
    const currentUser = localStorage.getItem("currentUser");
    if(currentUser !== "admin") {
        alert("Acceso denegado");
        window.location.href = "index.html";
    } else {
        renderUsers();
        renderPageChecklist('newUserPages');
    }
};

// === GENERAR CHECKBOXES DINÁMICOS ===
function renderPageChecklist(containerId, selectedPages = []) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    availablePages.forEach(page => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = page;
        if (selectedPages.includes(page)) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + page));
        container.appendChild(label);
    });
}

// === MOSTRAR USUARIOS (SIN ADMIN) ===
function renderUsers() {
    const table = document.getElementById("userTable");
    table.innerHTML = '<tr><th>Usuario</th><th>Contraseña</th><th>Páginas</th><th>Acciones</th></tr>';

    usersRef.once('value', snapshot => {
        snapshot.forEach(childSnap => {
            const user = childSnap.key;
            const data = childSnap.val();
            if(user === "admin") return; // ocultar admin

            const row = table.insertRow();
            row.insertCell(0).textContent = user;
            row.insertCell(1).textContent = atob(data.password);
            row.insertCell(2).textContent = data.pages.join(", ");

            const actions = row.insertCell(3);

            const editBtn = document.createElement("button");
            editBtn.textContent = "Editar";
            editBtn.onclick = () => editUser(user, data);
            actions.appendChild(editBtn);

            const delBtn = document.createElement("button");
            delBtn.textContent = "Eliminar";
            delBtn.onclick = () => deleteUser(user);
            actions.appendChild(delBtn);
        });
    });
}

// === AÑADIR USUARIO ===
function addUser() {
    const username = document.getElementById("newUser").value.trim();
    const password = document.getElementById("newPass").value.trim();
    const pages = Array.from(document.querySelectorAll('#newUserPages input:checked')).map(cb => cb.value);

    if(!username || !password) { 
        alert("Usuario y contraseña obligatorios");
        return; 
    }

    usersRef.child(username).set({
        password: btoa(password),
        pages
    });
    renderUsers();
    document.getElementById("newUser").value = "";
    document.getElementById("newPass").value = "";
    renderPageChecklist('newUserPages');
}

// === EDITAR ADMIN (MODAL) ===
function editAdmin() {
    usersRef.child("admin").once('value', snapshot => {
        if (!snapshot.exists()) {
            alert("No se encontró el usuario admin.");
            return;
        }
        const data = snapshot.val();

        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';

        modal.innerHTML = `
            <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:100%;">
                <h3>Editar cuenta ADMIN</h3>
                <label>Nueva contraseña:</label>
                <input type="text" id="adminPassword" value="${atob(data.password)}" style="width:100%; margin-bottom:10px; padding:5px;">
                <label>Páginas:</label>
                <div id="adminPages" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;">
                </div>
                <div style="text-align:right;">
                    <button id="cancelAdmin" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                    <button id="saveAdmin" style="background:green; color:white;">Guardar</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        renderPageChecklist('adminPages', data.pages);

        document.getElementById('cancelAdmin').onclick = () => modal.remove();

        document.getElementById('saveAdmin').onclick = () => {
            const newPassword = document.getElementById('adminPassword').value.trim();
            const newPages = Array.from(document.querySelectorAll('#adminPages input:checked')).map(cb => cb.value);

            if (!newPassword) {
                alert("La contraseña no puede estar vacía.");
                return;
            }

            usersRef.child("admin").update({
                password: btoa(newPassword),
                pages: newPages
            }).then(() => {
                alert("Cuenta admin actualizada.");
                modal.remove();
            }).catch(err => {
                alert("Error al actualizar admin: " + err.message);
            });
        };
    });
}

// === EDITAR USUARIO NORMAL ===
function editUser(user, data) {
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.zIndex = '1000';

    modal.innerHTML = `
        <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:100%;">
            <h3>Editar usuario: ${user}</h3>
            <label>Nueva contraseña:</label>
            <input type="text" id="editPassword" value="${atob(data.password)}" style="width:100%; margin-bottom:10px; padding:5px;">
            <label>Páginas:</label>
            <div id="editUserPages" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
            <div style="text-align:right;">
                <button id="cancelEdit" style="margin-right:10px; background:gray; color:white;">Cancelar</button>
                <button id="saveChanges" style="background:green; color:white;">Guardar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    renderPageChecklist('editUserPages', data.pages);

    document.getElementById('cancelEdit').onclick = () => modal.remove();

    document.getElementById('saveChanges').onclick = () => {
        const newPassword = document.getElementById('editPassword').value.trim();
        const newPages = Array.from(document.querySelectorAll('#editUserPages input:checked')).map(cb => cb.value);

        if (!newPassword) {
            alert("La contraseña no puede estar vacía.");
            return;
        }

        usersRef.child(user).update({
            password: btoa(newPassword),
            pages: newPages
        }).then(() => {
            alert("Usuario actualizado con éxito.");
            modal.remove();
            renderUsers();
        }).catch(err => {
            alert("Error al actualizar usuario: " + err.message);
        });
    };
}

// === ELIMINAR USUARIO ===
function deleteUser(user) {
    if(confirm("¿Eliminar usuario " + user + "?")) {
        usersRef.child(user).remove();
        renderUsers();
    }
}

// === CERRAR SESIÓN ===
function logout() {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
}
</script>
</body>
</html>
